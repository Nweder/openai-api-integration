<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chat</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 30px auto; }
    #chat { border: 1px solid #333; padding: 12px; min-height: 300px; border-radius: 8px; }
    .msg { margin: 8px 0; }
    .user { font-weight: 700; }
    .assistant { font-weight: 700; }
    form { display: flex; gap: 10px; margin-top: 12px; }
    input { flex: 1; padding: 10px; }
    button { padding: 10px 14px; }
  </style>
</head>
<body>
  <h2>AI Chat</h2>

  <div id="chat"></div>

  <form id="form">
    <input id="q" placeholder="Type your message..." autocomplete="off" />
    <button type="submit">Send</button>
  </form>

  <script>
    const chat = document.getElementById("chat");
    const form = document.getElementById("form");
    const q = document.getElementById("q");

    function render(messages) {
      chat.innerHTML = "";
      for (const m of messages) {
        const div = document.createElement("div");
        div.className = "msg";
        const role = m.role === "user" ? "You" : "AI";
        div.innerHTML = `<span class="${m.role}">${role}:</span> ${escapeHtml(m.content)}`;
        chat.appendChild(div);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    async function loadHistory() {
      const r = await fetch("/history");
      const data = await r.json();
      render(data.messages || []);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = q.value.trim();
      if (!question) return;

      q.value = "";
      // Optimistisk render: visa direkt i UI
      const current = [...chat.querySelectorAll(".msg")].length;

      const r = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });

      const data = await r.json();
      if (data.error) {
        alert(data.error);
        return;
      }
      render(data.messages || []);
    });

    loadHistory();
  </script>
</body>
</html>
